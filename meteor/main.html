<head>
    <meta charset="utf-8">
    <title>Counteract</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/ratchet/2.0.2/css/ratchet-theme-ios.min.css">
    <script type="text/javascript" src="heap.js"></script>
    <script type="text/javascript" src="http://momentjs.com/downloads/moment.min.js"></script>
    <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>
</head>

<body>
    {{>Template.dynamic template=main}}
    <script type="text/javascript">
    new WOW().init()
    </script>
</body>
<template name="home">
    <div class="hero" style="height: 100%">
        <div class="element" align="center">
            <h1 class="title"><span class="wow fadeInUp title" data-wow-delay="1s">C</span><i class="fa fa-repeat spin"></i><span class="wow fadeInUp title" data-wow-delay="1s"><span class="u title">u</span>nteract</span></h1>
            <h4 class="wow fadeInUp" data-wow-delay="1500ms" style="color: #FFF">Fighting terrorism without guns</h4>
            <hr style="width: 100px;border-bottom: 5px solid #FFF" class="wow zoomIn" data-wow-delay="1750ms">
            <a href="#about" style="color: #FFF"><h1><i class="fa fa-angle-down wow fadeInDown" data-wow-delay="2s"></i></h1></a>
        </div>
    </div>
    <div class="about" id="about" style="height: 100%">
        <div class="element" align="center">
            <div class="container">
                <h1 class="wow fadeInUp">About <span class="wow fadeInUp title" data-wow-delay="250ms">Counteract</span></h1>
                <hr style="width: 100px;border-bottom: 5px solid #000" class="wow zoomIn" data-wow-delay="750ms">
                <h4 class="wow fadeIn" data-wow-delay="1s"><span class="wow fadeInUp" data-wow-delay="1s">Counteract is a platform that detects and aids mental health patients who pose a high risk of harm to themselves or to other people</span></h4>
                <h4><a href="#demo" class="wow fadeInUp" data-wow-delay="1500ms">Try it out <i class="fa fa-angle-right"></i></a></h4>
            </div>
        </div>
    </div>
    <div id="demo" style="height: 100%">
        <div class="element">
            <div class="container">
                <center>
                    <h1 class="wow fadeInUp">Check <span class="wow fadeInUp title" data-wow-delay="250ms">it</span> <span class="wow fadeInUp title" data-wow-delay="500ms">out!</span></h1></center>
                <hr style="width: 100px;border-bottom: 5px solid #000" class="wow zoomIn" data-wow-delay="750ms">
                <br>
                <center>
                    <h5>This is a live demo of the tweets coming into and being processed by our server</h5></center>
                {{>map}}
            </div>
        </div>
    </div>
    <div class="jumbotron jumbotron-job" align="center" style="background: #2D2D2D;color: #FFF;padding-top: 50px;padding-bottom: 50px">
        <div class="container">
            <h2 class="wow fadeInUp title upper">Get <span class="wow fadeInUp title upper" data-wow-delay="250ms">In</span> <span class="wow fadeInUp title upper" data-wow-delay="500ms">Touch</span></h2>
            <hr class="wow zoomIn" data-wow-delay="750ms" style="width: 100px;border: 2px solid #2D2D2D">
            <form action="https://docs.google.com/forms/d/1SfoEoEvrffm9Wwjv_JR6N77VcVjz2DX3w-SNmiYnnDc/formResponse" method="POST" id="ss-form" target="_self" onsubmit="" class="wow fadeIn" data-wow-delay="500ms">
                <ol role="list" class="ss-question-list" style="padding-left: 0">
                    <input type="email" placeholder="Your Email *" name="entry.590052548" value="" class="ss-q-short" id="entry_590052548" dir="auto" aria-label="Name  " aria-required="true" required="" title="" style="width:50%">
                    <br>
                    <br>
                    <textarea name="entry.350270304" rows="8" cols="0" class="ss-q-long" id="entry_350270304" dir="auto" aria-label="How may we help you?  " placeholder="How may we help you?  " aria-required="true" required="" style="width:50%"></textarea>
                    <br>
                    <input type="hidden" name="draftResponse" value="[,,&quot;-358895960907417255&quot;]
">
                    <input type="hidden" name="pageHistory" value="0">
                    <input type="hidden" name="fbzx" value="-358895960907417255">
                    <input type="submit" name="submit" value="Submit" id="ss-submit" class="jfk-button jfk-button-action btn btn-primary">
                </ol>
            </form>
        </div>
    </div>
</template>
<template name="vis">
    <nav>
        <div class="nav-wrapper hero" style="margin-bottom: 50px;background: #FF2D55">
            <a href="#" class="brand-logo center">COUNTERACT</a>
        </div>
    </nav>
    <div style="margin-top: 50px;margin-bottom: 50px">
        <center>
            <h3 class="title">Real-time Map</h3></center>{{>map}}
    </div>
    <div style="margin-bottom: 50px;" align="center">
        <h3>Tweets and Accounts to Track</h3>
        <div class="container">
        <div id="accounts" class="row">
        </div>
        </div>
    </div>
    <script type="text/javascript">Session.set('ngrok', prompt('what ngrok?'))</script>
</template>
<template name="map">
    <div id="myMap" style="border: 1px solid #000;width: 50%;margin-left: 25%" class="wow fadeIn" data-wow-delay="1s"></div>
    <script type="text/javascript">
    $("#myMap").css('height', $("#myMap").width() * .6)
    var map = new Datamap({
        element: document.getElementById('myMap'),
        fills: {
            RED: '#E84343',
            defaultFill: '#CFCFCF'
        },
        done: function(datamap) {
            datamap.svg.call(d3.behavior.zoom().on('zoom', redraw));

            function redraw() {
                datamap.svg.selectAll('g').attr('transform', 'translate(' + d3.event.translate + ')scale(' + d3.event.scale + ')');
            }
        }
    });
    $(function() {
        $('a[href*=#]:not([href=#])').click(function() {
            if (location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '') && location.hostname == this.hostname) {

                var target = $(this.hash);
                target = target.length ? target : $('[name=' + this.hash.slice(1) + ']');
                if (target.length) {
                    $('html,body').animate({
                        scrollTop: target.offset().top
                    }, 1000);
                    return false;
                }
            }
            this.toggleClass("active");
        });
    });
    $(".fa-repeat").css('font-size', .6 * $(".u").height())
    Tracker.autorun(function() {
        Meteor.subscribe("tweet", function() {
            map.bubbles(tweets.find().fetch(), {
                popupTemplate: function(geo, data) {
                    return ['<div class="hoverinfo">' + data.name + ' (@' + data.handle + ')',
                        '<br/>' + data.content + '',
                        '<br/><br/>Risk: ' + data.radius * 10 + '',
                        '<br/>Date: ' + moment(parseInt(data.date)).calendar() + '',
                        '</div>'
                    ].join('');
                }
            });
        });
        Meteor.subscribe("tweets", function() {
            console.log(tweet.find().fetch())
            return tweet.find().fetch()
        })
        tweetnow = tweet.find().fetch()
        tweet.find().observeChanges({
            added: function(id, doc) {
                $("#accounts").append('<div class="col s4"><a href="' + doc.tweet + '" style="color: #000"><h6><img src="https://twitter.com/' + doc.handle + '/profile_image?size=normal" style="border-radius: 50%"> @' + doc.handle + '</h6></a><input type="text" class="reply" id="' + doc.handle + '" link="' + doc.tweet + '"></div>')
            }
        });
        $(".reply").keypress(function(e) {
            if (e.which == 13) {
                var data = {
                    'handle': $(this).attr('id'),
                    'message': $(this).val()
                };
                console.log(data)
                $.ajax({
                    type: "GET",
                    url: "http://"+Session.get('ngrok')+".ngrok.io/tweet",
                    data: data,
                    contentType: 'application/json;charset=UTF-8',
                    success: function(result) {
                        alert('Tweeted: @' +$(this).attr('id')+' '+$(this).val())
                    }
                });
                alert('Tweeted: @' +$(this).attr('id')+' '+$(this).val())
                $(this).parent().fadeOut()
            }
        })
        return tweet.find().fetch()
        map.bubbles(tweets.find().fetch(), {
            popupTemplate: function(geo, data) {
                return ['<div class="hoverinfo">' + data.name + ' (@' + data.handle + ')',
                    '<br/>' + data.content + '',
                    '<br/><br/>Risk: ' + data.radius * 10 + '',
                    '<br/>Date: ' + moment(parseInt(data.date)).calendar() + '',
                    '</div>'
                ].join('');
            }
        });
    });
    </script>
</template>
